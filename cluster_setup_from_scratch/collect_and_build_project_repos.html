<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Collect and Build Project Repos &mdash; Cloud Builder 0.2.64 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Setup Cloud Builder From AMIs" href="../cluster_setup_from_cb_amis.html" />
    <link rel="prev" title="Auto Rebuild on Package Build Dependency Changes" href="auto_rebuild_on_build_dependencies.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Cloud Builder
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">Quick Start</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#cloud-builder-source-setup">Cloud Builder Source Setup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../quickstart/git_package_source_setup.html">Git Package Source Setup</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../quickstart/git_package_source_setup.html#understanding-the-project-structure">Understanding the project structure</a></li>
<li class="toctree-l4"><a class="reference internal" href="../quickstart/git_package_source_setup.html#understanding-cb-cloud-builder-yml">Understanding <code class="file docutils literal notranslate"><span class="pre">.cb/cloud_builder.yml</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../quickstart/git_package_source_setup.html#understanding-cb-build-root-kiwi">Understanding <code class="file docutils literal notranslate"><span class="pre">.cb/build_root.kiwi</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../quickstart/git_image_source_setup.html">Git Image Source Setup</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../quickstart/git_image_source_setup.html#understanding-the-project-structure">Understanding the project structure</a></li>
<li class="toctree-l4"><a class="reference internal" href="../quickstart/git_image_source_setup.html#understanding-cb-cloud-builder-yml">Understanding <code class="file docutils literal notranslate"><span class="pre">.cb/cloud_builder.yml</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="../cluster_setup_from_scratch.html">Setup Cloud Builder From Scratch</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="kafka_broker_setup.html">Kafka Message Broker Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="control_plane_setup.html">Create and Install the Control Plane</a><ul>
<li class="toctree-l3"><a class="reference internal" href="control_plane_setup.html#control-plane-configuration">Control Plane Configuration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="runner_setup.html">Runner Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="request_package_build.html">Request a Package Build</a></li>
<li class="toctree-l2"><a class="reference internal" href="auto_rebuild_on_source_change.html">Auto Rebuild on Package Source Change</a></li>
<li class="toctree-l2"><a class="reference internal" href="auto_rebuild_on_build_dependencies.html">Auto Rebuild on Package Build Dependency Changes</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Collect and Build Project Repos</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#create-and-setup-the-reposerver-instance">Create and Setup the reposerver instance</a></li>
<li class="toctree-l3"><a class="reference internal" href="#setup-apache-to-serve-the-repos">Setup Apache to Serve the Repos</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../cluster_setup_from_cb_amis.html">Setup Cloud Builder From AMIs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../cluster_setup_from_cb_amis.html#prerequisites">Prerequisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cluster_setup_from_cb_amis.html#create-cluster">Create Cluster</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../commands.html">Overview Cloud Builder Services</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../commands/cb_fetch.html">cb-fetch</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../commands/cb_fetch.html#synopsis">SYNOPSIS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../commands/cb_fetch.html#description">DESCRIPTION</a></li>
<li class="toctree-l3"><a class="reference internal" href="../commands/cb_fetch.html#options">OPTIONS</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../commands/cb_scheduler.html">cb-scheduler</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../commands/cb_scheduler.html#synopsis">SYNOPSIS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../commands/cb_scheduler.html#description">DESCRIPTION</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../commands/cb_scheduler.html#building-a-package">Building a package:</a></li>
<li class="toctree-l4"><a class="reference internal" href="../commands/cb_scheduler.html#build-an-os-image">Build an OS image:</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../commands/cb_scheduler.html#options">OPTIONS</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../commands/cb_prepare.html">cb-prepare</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../commands/cb_prepare.html#synopsis">SYNOPSIS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../commands/cb_prepare.html#description">DESCRIPTION</a></li>
<li class="toctree-l3"><a class="reference internal" href="../commands/cb_prepare.html#options">OPTIONS</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../commands/cb_run.html">cb-run</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../commands/cb_run.html#synopsis">SYNOPSIS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../commands/cb_run.html#description">DESCRIPTION</a></li>
<li class="toctree-l3"><a class="reference internal" href="../commands/cb_run.html#options">OPTIONS</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../commands/cb_image.html">cb-image</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../commands/cb_image.html#synopsis">SYNOPSIS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../commands/cb_image.html#description">DESCRIPTION</a></li>
<li class="toctree-l3"><a class="reference internal" href="../commands/cb_image.html#options">OPTIONS</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../commands/cb_info.html">cb-info</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../commands/cb_info.html#synopsis">SYNOPSIS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../commands/cb_info.html#description">DESCRIPTION</a></li>
<li class="toctree-l3"><a class="reference internal" href="../commands/cb_info.html#options">OPTIONS</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../commands/cb_depsolver.html">cb-depsolver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../commands/cb_collect.html">cb-collect</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../commands/cb_collect.html#synopsis">SYNOPSIS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../commands/cb_collect.html#description">DESCRIPTION</a></li>
<li class="toctree-l3"><a class="reference internal" href="../commands/cb_collect.html#options">OPTIONS</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../commands/cb_ctl.html">cb-ctl</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../commands/cb_ctl.html#synopsis">SYNOPSIS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../commands/cb_ctl.html#description">DESCRIPTION</a></li>
<li class="toctree-l3"><a class="reference internal" href="../commands/cb_ctl.html#options">OPTIONS</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Cloud Builder</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../cluster_setup_from_scratch.html">Setup Cloud Builder From Scratch</a> &raquo;</li>
      <li>Collect and Build Project Repos</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/cluster_setup_from_scratch/collect_and_build_project_repos.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="collect-and-build-project-repos">
<span id="id1"></span><h1>Collect and Build Project Repos<a class="headerlink" href="#collect-and-build-project-repos" title="Permalink to this headline">¶</a></h1>
<p>Building the packages on the runner(s) is the foundation of
the Cloud Builder project. However, first the possibility to create
and publish package repositories creates real value to it.
The <code class="xref py py-obj docutils literal notranslate"><span class="pre">cb-collect</span></code> service implements the creation of package
repositories by allowing the runners to sync their build results
to the collector. <code class="xref py py-obj docutils literal notranslate"><span class="pre">cb-collect</span></code> periodically runs over this
data and creates package metadata such that package managers
can consume them.</p>
<p>This chapter describes how to setup <code class="xref py py-obj docutils literal notranslate"><span class="pre">cb-collect</span></code> in combination
with an <code class="xref py py-obj docutils literal notranslate"><span class="pre">apache</span></code> web-server to serve the <code class="xref py py-obj docutils literal notranslate"><span class="pre">cb-collect</span></code> created
repositories. Let’s call this instance the <code class="xref py py-obj docutils literal notranslate"><span class="pre">reposerver</span></code>.</p>
<section id="create-and-setup-the-reposerver-instance">
<h2>Create and Setup the reposerver instance<a class="headerlink" href="#create-and-setup-the-reposerver-instance" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p><strong>Start reposerver instance</strong></p>
<p>For the reposerver there is no real requirement to use a
specific linux distribution. In this document the Leap
distribution is used. In AWS EC2 the following AMI ID
can be used to run the instance:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">leap_15_3_ami</span><span class="o">=</span>ami-0b4f49bedf96b14c9
<span class="nv">username</span><span class="o">=</span>ec2-user
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The reposerver instance requires a good network connection
as well as enough storage capacity to store the repository
data. Therefore the selected <code class="xref py py-obj docutils literal notranslate"><span class="pre">t2.micro</span></code> instance type might
not be sufficient depending on what magnitude the Cloud Builder
services are used</p>
</div>
</li>
<li><p><strong>Install Cloud Builder on the reposerver</strong></p>
<p>Login to the reposerver instance and install Cloud Builder as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ssh -i PathToPkeyMatchingMySSHKeyPairName <span class="se">\</span>
    <span class="si">${</span><span class="nv">username</span><span class="si">}</span>@RepoServerInstanceIP

sudo zypper addrepo https://download.opensuse.org/repositories/Virtualization:/Appliances:/CloudBuilder/openSUSE_Leap_15.3 cloud-builder
sudo zypper install python3-cloud_builder
</pre></div>
</div>
</li>
<li><p><strong>Setup cb-collect service configuration</strong></p>
<p>Still logged in on the reposerver the file <code class="file docutils literal notranslate"><span class="pre">/etc/cloud_builder</span></code>
contains service parameters which needs to be setup as follows:</p>
<dl>
<dt><strong>git package source connection</strong></dt><dd><p>The below setting is the default after install of Cloud Builder.
The used CB_PROJECT git repository is the Cloud Builder provided example git
repo containing some arbitrary package sources. It only serves the
purpose to let users test and run Cloud Builder. For production
change this value to your git project</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">CB_PROJECT</span><span class="o">=</span><span class="s2">&quot;https://github.com/OSInside/cloud-builder-packages.git&quot;</span>
</pre></div>
</div>
</dd>
</dl>
</li>
<li><p><strong>Allow SSH access from runners</strong></p>
<p>To allow the runners to push their build results to the
collector it’s required to allow the runners SSH pub key
in the <code class="file docutils literal notranslate"><span class="pre">authorized_keys</span></code> file of the reposerver.</p>
<p>During the setup of the control plane a SSH keypair has already
been created and rolled out to the runners. The same keypair
as present on the control plane can now also be used on the
reposerver as follows:</p>
<ol class="arabic">
<li><p>Login to the control plane from a new terminal session.</p>
<p>See <a class="reference internal" href="control_plane_setup.html#control-plane-setup"><span class="std std-ref">Create and Install the Control Plane</span></a> for details</p>
</li>
<li><p>Fetch the <code class="xref py py-obj docutils literal notranslate"><span class="pre">cb-collect</span></code> public SSH key.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cat ~/.ssh/id_cb_collect.pub

<span class="o">==</span>&gt; Copy the SSH public key into the Copy/Paste buffer

<span class="nb">exit</span>
</pre></div>
</div>
<p>Add the SSH public key to the <code class="file docutils literal notranslate"><span class="pre">authorized_keys</span></code> file
on the <strong>reposerver</strong> as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>vi ~/.ssh/authorized_keys

<span class="o">==</span>&gt; Paste the SSH public key from the Copy/Paste buffer
</pre></div>
</div>
</li>
</ol>
</li>
<li><p><strong>Setup runners to sync their results to the collector</strong></p>
<p>In the setup of the runners the settings to connect to the
collector were not configured. This must be done now as follows:</p>
<ol class="arabic">
<li><p>Login to a runner instance</p></li>
<li><p>On the runner instance edit the file <code class="file docutils literal notranslate"><span class="pre">/etc/cloud_builder</span></code>
and set/update the following parameters:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">CB_COLLECT_REPO_SERVER</span><span class="o">=</span><span class="s2">&quot;RepoServerInstanceIP&quot;</span>
<span class="nv">CB_SSH_USER</span><span class="o">=</span><span class="s2">&quot;ec2-user&quot;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Make sure the user(ec2-user in this example) also has
permissions to write data in <code class="file docutils literal notranslate"><span class="pre">/srv/www/</span></code>. This is
the place the runners will upload its data.</p>
</div>
</li>
<li><p>Restart the scheduler</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>systemctl restart cb-scheduler
</pre></div>
</div>
</li>
<li><p>Repeat this steps for all runners of interest</p></li>
</ol>
</li>
<li><p><strong>Start</strong> <code class="xref py py-obj docutils literal notranslate"><span class="pre">cb-collect</span></code> <strong>service</strong></p>
<p>Still logged in on the reposerver, start the <code class="xref py py-obj docutils literal notranslate"><span class="pre">cb-collect</span></code> service
as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo systemctl start cb-collect
</pre></div>
</div>
<p>The service will immediately start to build repositories from
the available package data. Package and images arrives through
build requests.</p>
</li>
</ol>
</section>
<section id="setup-apache-to-serve-the-repos">
<h2>Setup Apache to Serve the Repos<a class="headerlink" href="#setup-apache-to-serve-the-repos" title="Permalink to this headline">¶</a></h2>
<p>All repos created by the <code class="xref py py-obj docutils literal notranslate"><span class="pre">cb-collect</span></code> service are now available
and managed on the local system. To consume the repos the <code class="xref py py-obj docutils literal notranslate"><span class="pre">Apache</span></code>
web server is used. The following describes a very simple setup
for <code class="xref py py-obj docutils literal notranslate"><span class="pre">Apache</span></code> to serve the <code class="file docutils literal notranslate"><span class="pre">/srv/www/projects/projects</span></code>
contents.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The following setup instructions for <code class="xref py py-obj docutils literal notranslate"><span class="pre">Apache</span></code> are valid if
the reposerver is based on the Leap distribution. In case
another distribution was used, adaptions to the information
below are likely.</p>
</div>
<ol class="arabic">
<li><p><strong>Install</strong> <code class="xref py py-obj docutils literal notranslate"><span class="pre">Apache</span></code></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo zypper <span class="k">in</span> apache2
</pre></div>
</div>
</li>
<li><p><strong>Setup Apache DocumentRoot</strong></p>
<p>Edit the file <code class="file docutils literal notranslate"><span class="pre">/etc/apache2/httpd.conf</span></code> and place the
following content at the end of the file:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>DocumentRoot <span class="s2">&quot;/srv/www/projects/projects&quot;</span>

&lt;Directory <span class="s2">&quot;/srv/www/projects/projects&quot;</span>&gt;
    Options All Indexes FollowSymLinks
    AllowOverride None
    Require all granted
&lt;/Directory&gt;
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For a real production setup including https access,
more config steps are needed. In addition the <code class="xref py py-obj docutils literal notranslate"><span class="pre">Apache</span></code>
documentation recommends to place setup instructions
in separate files and only include them in the master
configuration. This all makes sense, so please consider
the above as an example to get started.</p>
</div>
</li>
<li><p><strong>Start</strong> <code class="xref py py-obj docutils literal notranslate"><span class="pre">Apache</span></code></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo systemctl start apache2
</pre></div>
</div>
</li>
<li><p><strong>Open HTTP port</strong></p>
<p>By default instances in the cloud blocks all inbound ports.
To access the server the HTTP port must be opened for
incomming connections. To do this add a new HTTP(80) inbound rule
in the used security group of the reposerver instance. The
documentation from here: <a class="reference external" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/authorizing-access-to-an-instance.html">https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/authorizing-access-to-an-instance.html</a> helps with that task</p>
</li>
<li><p><strong>Access the reposerver</strong></p>
<p>Open a web browser and place the following URL:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>http://RepoServerInstanceIP
</pre></div>
</div>
</li>
</ol>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="auto_rebuild_on_build_dependencies.html" class="btn btn-neutral float-left" title="Auto Rebuild on Package Build Dependency Changes" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../cluster_setup_from_cb_amis.html" class="btn btn-neutral float-right" title="Setup Cloud Builder From AMIs" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Marcus Schäfer.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>