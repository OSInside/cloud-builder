<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>cb-scheduler &mdash; Cloud Builder 0.2.6 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="cb-prepare" href="cb_prepare.html" />
    <link rel="prev" title="cb-fetch" href="cb_fetch.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Cloud Builder
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../infrastructure_setup.html">Infrastructure Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../git_package_source_setup.html">Git Package Source Setup</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../git_package_source_setup.html#understanding-the-project-structure">Understanding the project structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../git_package_source_setup.html#understanding-cloud-builder-yml">Understanding <code class="file docutils literal notranslate"><span class="pre">cloud_builder.yml</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../git_package_source_setup.html#understanding-cloud-builder-kiwi">Understanding <code class="file docutils literal notranslate"><span class="pre">cloud_builder.kiwi</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../kafka_broker_setup.html">Kafka Message Broker Setup</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../kafka_broker_setup.html#create-and-install-the-control-plane">Create and Install the Control Plane</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kafka_broker_setup.html#control-plane-setup">Control Plane Setup</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../runner_setup.html">Runner Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../request_package_build.html">Request a Package Build</a></li>
<li class="toctree-l1"><a class="reference internal" href="../auto_rebuild_on_source_change.html">Auto Rebuild on Package Source Change</a></li>
<li class="toctree-l1"><a class="reference internal" href="../auto_rebuild_on_build_dependencies.html">Auto Rebuild on Package Build Dependency Changes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../collect_and_build_project_repos.html">Collect and Build Project Repos</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../collect_and_build_project_repos.html#create-and-setup-the-reposerver-instance">Create and Setup the reposerver instance</a></li>
<li class="toctree-l2"><a class="reference internal" href="../collect_and_build_project_repos.html#setup-apache-to-serve-the-repos">Setup Apache to Serve the Repos</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="../commands.html">Overview Cloud Builder Services</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="cb_fetch.html">cb-fetch</a><ul>
<li class="toctree-l3"><a class="reference internal" href="cb_fetch.html#synopsis">SYNOPSIS</a></li>
<li class="toctree-l3"><a class="reference internal" href="cb_fetch.html#description">DESCRIPTION</a></li>
<li class="toctree-l3"><a class="reference internal" href="cb_fetch.html#options">OPTIONS</a></li>
</ul>
</li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">cb-scheduler</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#synopsis">SYNOPSIS</a></li>
<li class="toctree-l3"><a class="reference internal" href="#description">DESCRIPTION</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#building-a-package">Building a package:</a></li>
<li class="toctree-l4"><a class="reference internal" href="#build-an-os-image">Build an OS image:</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#options">OPTIONS</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="cb_prepare.html">cb-prepare</a><ul>
<li class="toctree-l3"><a class="reference internal" href="cb_prepare.html#synopsis">SYNOPSIS</a></li>
<li class="toctree-l3"><a class="reference internal" href="cb_prepare.html#description">DESCRIPTION</a></li>
<li class="toctree-l3"><a class="reference internal" href="cb_prepare.html#options">OPTIONS</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="cb_run.html">cb-run</a><ul>
<li class="toctree-l3"><a class="reference internal" href="cb_run.html#synopsis">SYNOPSIS</a></li>
<li class="toctree-l3"><a class="reference internal" href="cb_run.html#description">DESCRIPTION</a></li>
<li class="toctree-l3"><a class="reference internal" href="cb_run.html#options">OPTIONS</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="cb_image.html">cb-image</a><ul>
<li class="toctree-l3"><a class="reference internal" href="cb_image.html#synopsis">SYNOPSIS</a></li>
<li class="toctree-l3"><a class="reference internal" href="cb_image.html#description">DESCRIPTION</a></li>
<li class="toctree-l3"><a class="reference internal" href="cb_image.html#options">OPTIONS</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="cb_info.html">cb-info</a><ul>
<li class="toctree-l3"><a class="reference internal" href="cb_info.html#synopsis">SYNOPSIS</a></li>
<li class="toctree-l3"><a class="reference internal" href="cb_info.html#description">DESCRIPTION</a></li>
<li class="toctree-l3"><a class="reference internal" href="cb_info.html#options">OPTIONS</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="cb_depsolver.html">cb-depsolver</a></li>
<li class="toctree-l2"><a class="reference internal" href="cb_collect.html">cb-collect</a><ul>
<li class="toctree-l3"><a class="reference internal" href="cb_collect.html#synopsis">SYNOPSIS</a></li>
<li class="toctree-l3"><a class="reference internal" href="cb_collect.html#description">DESCRIPTION</a></li>
<li class="toctree-l3"><a class="reference internal" href="cb_collect.html#options">OPTIONS</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="cb_ctl.html">cb-ctl</a><ul>
<li class="toctree-l3"><a class="reference internal" href="cb_ctl.html#synopsis">SYNOPSIS</a></li>
<li class="toctree-l3"><a class="reference internal" href="cb_ctl.html#description">DESCRIPTION</a></li>
<li class="toctree-l3"><a class="reference internal" href="cb_ctl.html#options">OPTIONS</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Cloud Builder</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../commands.html">Overview Cloud Builder Services</a> &raquo;</li>
      <li>cb-scheduler</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/commands/cb_scheduler.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="cb-scheduler">
<h1>cb-scheduler<a class="headerlink" href="#cb-scheduler" title="Permalink to this headline">¶</a></h1>
<section id="synopsis">
<h2>SYNOPSIS<a class="headerlink" href="#synopsis" title="Permalink to this headline">¶</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cb-scheduler -h <span class="p">|</span> --help
cb-scheduler
    <span class="o">[</span>--update-interval<span class="o">=</span>&lt;time_sec&gt;<span class="o">]</span>
    <span class="o">[</span>--poll-timeout<span class="o">=</span>&lt;time_msec&gt;<span class="o">]</span>
    <span class="o">[</span>--package-limit<span class="o">=</span>&lt;number&gt;<span class="o">]</span>
</pre></div>
</div>
</section>
<section id="description">
<h2>DESCRIPTION<a class="headerlink" href="#description" title="Permalink to this headline">¶</a></h2>
<p>cb-scheduler - listens on incoming package/image build requests
from the message broker on a regular schedule. Only if
the max package/image to build limit is not exceeded, request
messages from the broker are accepted. In case the request
matches the runner capabilities e.g architecture it gets
acknowledged and removed from the broker queue.</p>
<section id="building-a-package">
<h3>Building a package:<a class="headerlink" href="#building-a-package" title="Permalink to this headline">¶</a></h3>
<p>A package can be build for different distribution targets
and architectures. Each distribution target/arch needs to
be configured as a profile in the .kiwi metadata and added
as effective build target in the package configuration file:</p>
<blockquote>
<div><ul class="simple">
<li><p>Defaults.get_cloud_builder_metadata_file_name()</p></li>
</ul>
</div></blockquote>
<p>An example package config to build the xclock package
for the Tumbleweed distribution for x86_64 and aarch64
would look like the following:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">schema_version</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.1</span>
<span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">xclock</span>

<span class="nt">distributions</span><span class="p">:</span>
  <span class="p p-Indicator">-</span>
    <span class="nt">dist</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">TW</span>
    <span class="nt">arch</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">x86_64</span>
    <span class="nt">runner_group</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">suse</span>

  <span class="p p-Indicator">-</span>
    <span class="nt">dist</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">TW</span>
    <span class="nt">arch</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">aarch64</span>
    <span class="nt">runner_group</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">suse</span>
</pre></div>
</div>
<p>The above instructs the scheduler to create two buildroot
environments, one for Tumbleweed(x86_64) and one for
Tumbleweed(aarch64) and build the xclock package in each
of these buildroots. To process this properly the scheduler
creates a script which calls cb-prepare followed by cb-run
with the corresponding parameters for each element of the
distributions list. Each dist.arch build process is triggered
by one build request. In the above example two requests
to build all targets in the distributions list would be
required.</p>
<p>The dist and arch settings of a distribution are combined
into profile names given to cb-prepare as parameter and used
in KIWI to create the buildroot environment. From the above
example this would lead to two profiles named:</p>
<ul class="simple">
<li><p>TW.x86_64</p></li>
<li><p>TW.aarch64</p></li>
</ul>
<p>The .kiwi metadata file has to provide instructions
such that the creation of a correct buildroot for these
profiles is possible.</p>
</section>
<section id="build-an-os-image">
<h3>Build an OS image:<a class="headerlink" href="#build-an-os-image" title="Permalink to this headline">¶</a></h3>
<p>An image can be build for different profiles, build arguments
and architectures. An example image config to build myimage
for myprofile and for the x86_64 achitecture would look like
the following:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">schema_version</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.1</span>
<span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">myimage</span>

<span class="nt">images</span><span class="p">:</span>
  <span class="p p-Indicator">-</span>
    <span class="nt">arch</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">x86_64</span>
    <span class="nt">runner_group</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">suse</span>
    <span class="nt">selection</span><span class="p">:</span>
      <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">standard</span>
      <span class="nt">profiles</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">myprofile</span>
      <span class="nt">build_arguments</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="s">&quot;--clear-cache&quot;</span>
</pre></div>
</div>
<p>The above instructs the scheduler to build one image for the
myprofile profile and the x86_64 achitecture on a runner in the
suse group. The package cache on this runner will be cleared
prior building the image. The image output files will get pacakged
into an rpm package. To do this properly the scheduler creates a
script which calls cb-image.</p>
<p>The directory containing the image config file:</p>
<blockquote>
<div><ul class="simple">
<li><p>Defaults.get_cloud_builder_metadata_file_name()</p></li>
</ul>
</div></blockquote>
<p>is treated as the image description and passed as such to the
KIWI image builder via cb-image. KIWI searches for a <code class="file docutils literal notranslate"><span class="pre">*.kiwi</span></code>
file to accept the directory as an image description. If the cloud
builder image config file names a profile, that profile must be
defined in the KIWI <code class="file docutils literal notranslate"><span class="pre">*.kiwi</span></code> file</p>
</section>
</section>
<section id="options">
<h2>OPTIONS<a class="headerlink" href="#options" title="Permalink to this headline">¶</a></h2>
<dl class="option-list">
<dt><kbd><span class="option">--update-interval=<var>&lt;time_sec&gt;</var></span></kbd></dt>
<dd><p>Optional update interval to reconnect to the
message broker. Default is 10sec</p>
</dd>
<dt><kbd><span class="option">--poll-timeout=<var>&lt;time_msec&gt;</var></span></kbd></dt>
<dd><p>Optional message broker poll timeout to return if no
requests are available. Default: 5000msec</p>
</dd>
<dt><kbd><span class="option">--package-limit=<var>&lt;number&gt;</var></span></kbd></dt>
<dd><p>Max number of package builds this scheduler handles
at the same time. Default: 10</p>
</dd>
</dl>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="cb_fetch.html" class="btn btn-neutral float-left" title="cb-fetch" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="cb_prepare.html" class="btn btn-neutral float-right" title="cb-prepare" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Marcus Schäfer.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>