<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Playground &mdash; Cloud Builder 0.2.31 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="cb-ctl" href="commands/cb_ctl.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> Cloud Builder
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="infrastructure_setup.html">Infrastructure Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="source_setup.html">Cloud Builder Source Setup</a><ul>
<li class="toctree-l2"><a class="reference internal" href="source_setup/git_package_source_setup.html">Git Package Source Setup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="source_setup/git_package_source_setup.html#understanding-the-project-structure">Understanding the project structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="source_setup/git_package_source_setup.html#understanding-cb-cloud-builder-yml">Understanding <code class="file docutils literal notranslate"><span class="pre">.cb/cloud_builder.yml</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="source_setup/git_package_source_setup.html#understanding-cb-build-root-kiwi">Understanding <code class="file docutils literal notranslate"><span class="pre">.cb/build_root.kiwi</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="source_setup/git_image_source_setup.html">Git Image Source Setup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="source_setup/git_image_source_setup.html#understanding-the-project-structure">Understanding the project structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="source_setup/git_image_source_setup.html#understanding-cb-cloud-builder-yml">Understanding <code class="file docutils literal notranslate"><span class="pre">.cb/cloud_builder.yml</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="kafka_broker_setup.html">Kafka Message Broker Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="control_plane_setup.html">Create and Install the Control Plane</a><ul>
<li class="toctree-l2"><a class="reference internal" href="control_plane_setup.html#control-plane-configuration">Control Plane Configuration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="runner_setup.html">Runner Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="request_package_build.html">Request a Package Build</a></li>
<li class="toctree-l1"><a class="reference internal" href="auto_rebuild_on_source_change.html">Auto Rebuild on Package Source Change</a></li>
<li class="toctree-l1"><a class="reference internal" href="auto_rebuild_on_build_dependencies.html">Auto Rebuild on Package Build Dependency Changes</a></li>
<li class="toctree-l1"><a class="reference internal" href="collect_and_build_project_repos.html">Collect and Build Project Repos</a><ul>
<li class="toctree-l2"><a class="reference internal" href="collect_and_build_project_repos.html#create-and-setup-the-reposerver-instance">Create and Setup the reposerver instance</a></li>
<li class="toctree-l2"><a class="reference internal" href="collect_and_build_project_repos.html#setup-apache-to-serve-the-repos">Setup Apache to Serve the Repos</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="commands.html">Overview Cloud Builder Services</a><ul>
<li class="toctree-l2"><a class="reference internal" href="commands/cb_fetch.html">cb-fetch</a><ul>
<li class="toctree-l3"><a class="reference internal" href="commands/cb_fetch.html#synopsis">SYNOPSIS</a></li>
<li class="toctree-l3"><a class="reference internal" href="commands/cb_fetch.html#description">DESCRIPTION</a></li>
<li class="toctree-l3"><a class="reference internal" href="commands/cb_fetch.html#options">OPTIONS</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="commands/cb_scheduler.html">cb-scheduler</a><ul>
<li class="toctree-l3"><a class="reference internal" href="commands/cb_scheduler.html#synopsis">SYNOPSIS</a></li>
<li class="toctree-l3"><a class="reference internal" href="commands/cb_scheduler.html#description">DESCRIPTION</a><ul>
<li class="toctree-l4"><a class="reference internal" href="commands/cb_scheduler.html#building-a-package">Building a package:</a></li>
<li class="toctree-l4"><a class="reference internal" href="commands/cb_scheduler.html#build-an-os-image">Build an OS image:</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="commands/cb_scheduler.html#options">OPTIONS</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="commands/cb_prepare.html">cb-prepare</a><ul>
<li class="toctree-l3"><a class="reference internal" href="commands/cb_prepare.html#synopsis">SYNOPSIS</a></li>
<li class="toctree-l3"><a class="reference internal" href="commands/cb_prepare.html#description">DESCRIPTION</a></li>
<li class="toctree-l3"><a class="reference internal" href="commands/cb_prepare.html#options">OPTIONS</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="commands/cb_run.html">cb-run</a><ul>
<li class="toctree-l3"><a class="reference internal" href="commands/cb_run.html#synopsis">SYNOPSIS</a></li>
<li class="toctree-l3"><a class="reference internal" href="commands/cb_run.html#description">DESCRIPTION</a></li>
<li class="toctree-l3"><a class="reference internal" href="commands/cb_run.html#options">OPTIONS</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="commands/cb_image.html">cb-image</a><ul>
<li class="toctree-l3"><a class="reference internal" href="commands/cb_image.html#synopsis">SYNOPSIS</a></li>
<li class="toctree-l3"><a class="reference internal" href="commands/cb_image.html#description">DESCRIPTION</a></li>
<li class="toctree-l3"><a class="reference internal" href="commands/cb_image.html#options">OPTIONS</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="commands/cb_info.html">cb-info</a><ul>
<li class="toctree-l3"><a class="reference internal" href="commands/cb_info.html#synopsis">SYNOPSIS</a></li>
<li class="toctree-l3"><a class="reference internal" href="commands/cb_info.html#description">DESCRIPTION</a></li>
<li class="toctree-l3"><a class="reference internal" href="commands/cb_info.html#options">OPTIONS</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="commands/cb_depsolver.html">cb-depsolver</a></li>
<li class="toctree-l2"><a class="reference internal" href="commands/cb_collect.html">cb-collect</a><ul>
<li class="toctree-l3"><a class="reference internal" href="commands/cb_collect.html#synopsis">SYNOPSIS</a></li>
<li class="toctree-l3"><a class="reference internal" href="commands/cb_collect.html#description">DESCRIPTION</a></li>
<li class="toctree-l3"><a class="reference internal" href="commands/cb_collect.html#options">OPTIONS</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="commands/cb_ctl.html">cb-ctl</a><ul>
<li class="toctree-l3"><a class="reference internal" href="commands/cb_ctl.html#synopsis">SYNOPSIS</a></li>
<li class="toctree-l3"><a class="reference internal" href="commands/cb_ctl.html#description">DESCRIPTION</a></li>
<li class="toctree-l3"><a class="reference internal" href="commands/cb_ctl.html#options">OPTIONS</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Playground</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#building-debian-packages">Building Debian Packages</a></li>
<li class="toctree-l2"><a class="reference internal" href="#simple-cluster-setup">Simple Cluster Setup</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Cloud Builder</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Playground</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/playground.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="playground">
<span id="id1"></span><h1>Playground<a class="headerlink" href="#playground" title="Permalink to this headline">¶</a></h1>
<p>This chapter contains just some sort of brain dump of things
I tried out, or other people can try out. An area for crazy
ideas and unfinished stuff.</p>
<p>Remember to have fun :)</p>
<section id="building-debian-packages">
<h2>Building Debian Packages<a class="headerlink" href="#building-debian-packages" title="Permalink to this headline">¶</a></h2>
<p>I was testing this and came across the following steps to build debs</p>
<ul>
<li><p>A Debian based host is needed. To have all the tools and a native
environment I think the runner should be a Debian host. It doesn’t
matter what it is, unstable, ubuntu, debian …</p></li>
<li><p>Add the Staging repo to <code class="file docutils literal notranslate"><span class="pre">/etc/apt/sources.list.d/cloud_builder.list</span></code></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>deb <span class="o">[</span><span class="nv">trusted</span><span class="o">=</span>yes check-valid-until<span class="o">=</span>no<span class="o">]</span> https://download.opensuse.org/repositories/Virtualization:/Appliances:/Staging/xUbuntu_20.04/ /
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ sudo apt update
$ sudo apt install python3-cloud-builder
</pre></div>
</div>
</li>
<li><p>Checkout the example packages repo</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ git clone https://github.com/OSInside/cloud-builder-packages.git
</pre></div>
</div>
</li>
<li><p>And run a local build</p>
<p>I put a debbuild prepared spec file for the python-kiwi packages
as an example. So this build will use debbuild which can consume
the information from an rpm spec file and create debs out of it.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>deb build with debbuild will not be accepted by the comunity
building with sources as they exist on <a class="reference external" href="https://salsa.debian.org/">https://salsa.debian.org/</a>
and a good debian/ directory with all dpkg metadata should also
be buildable via Cloud Builder</p>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> cloud-builder-packages/projects/MS/python-kiwi

$ sudo cb-ctl --build-package-local --dist focal
</pre></div>
</div>
</li>
</ul>
</section>
<section id="simple-cluster-setup">
<h2>Simple Cluster Setup<a class="headerlink" href="#simple-cluster-setup" title="Permalink to this headline">¶</a></h2>
<p>Using Kafka as a service produces costs. In Amazon the MSK service
cannot be simply stopped and restarted, it can only be deleted and
created from scratch. For this action several opportunities exists.
One of the simplest ist a shell script called from the control plane
instance and after creation of the MSK service via the web
console or the <code class="xref py py-obj docutils literal notranslate"><span class="pre">aws</span></code> tool using the AWS API.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="nb">set</span> -e

<span class="nb">source</span> setup_cluster.cfg

<span class="nb">pushd</span> kafka_2.12-2.2.1

<span class="c1"># standard topics...</span>
<span class="k">for</span> topic <span class="k">in</span> cb-response cb-info-request cb-info-response<span class="p">;</span> <span class="k">do</span>
    ./bin/kafka-topics.sh <span class="se">\</span>
        --create <span class="se">\</span>
        --zookeeper <span class="si">${</span><span class="nv">ZookeeperConnectString</span><span class="si">}</span> <span class="se">\</span>
        --replication-factor <span class="m">2</span> <span class="se">\</span>
        --partitions <span class="m">1</span> <span class="se">\</span>
        --topic <span class="si">${</span><span class="nv">topic</span><span class="si">}</span>
<span class="k">done</span>

<span class="c1"># runner group topics...</span>
<span class="k">for</span> topic <span class="k">in</span> fedora suse<span class="p">;</span> <span class="k">do</span>
    ./bin/kafka-topics.sh <span class="se">\</span>
        --create <span class="se">\</span>
        --zookeeper <span class="si">${</span><span class="nv">ZookeeperConnectString</span><span class="si">}</span> <span class="se">\</span>
        --replication-factor <span class="m">2</span> <span class="se">\</span>
        --partitions <span class="m">10</span> <span class="se">\</span>
        --topic <span class="si">${</span><span class="nv">topic</span><span class="si">}</span>
<span class="k">done</span>

<span class="c1"># retention times...</span>
<span class="k">for</span> topic <span class="k">in</span> fedora suse<span class="p">;</span> <span class="k">do</span>
    ./bin/kafka-topics.sh <span class="se">\</span>
        --alter <span class="se">\</span>
        --zookeeper <span class="si">${</span><span class="nv">ZookeeperConnectString</span><span class="si">}</span> <span class="se">\</span>
        --config retention.ms<span class="o">=</span><span class="m">3600000</span> <span class="se">\</span>
        --topic <span class="si">${</span><span class="nv">topic</span><span class="si">}</span>
<span class="k">done</span>
<span class="k">for</span> topic <span class="k">in</span> cb-info-response cb-info-request<span class="p">;</span> <span class="k">do</span>
    ./bin/kafka-topics.sh <span class="se">\</span>
        --alter <span class="se">\</span>
        --zookeeper <span class="si">${</span><span class="nv">ZookeeperConnectString</span><span class="si">}</span> <span class="se">\</span>
        --config retention.ms<span class="o">=</span><span class="m">120000</span> <span class="se">\</span>
        --topic <span class="si">${</span><span class="nv">topic</span><span class="si">}</span>
<span class="k">done</span>

<span class="c1"># update BootstrapServersString</span>
sudo sed -ie <span class="s2">&quot;s@  host:.*@  host: </span><span class="si">${</span><span class="nv">BootstrapServersString</span><span class="si">}</span><span class="s2">@&quot;</span> <span class="se">\</span>
    /etc/cloud_builder_broker.yml

<span class="c1"># update BootstrapServersString on runners</span>
<span class="nv">runner_leap1</span><span class="o">=</span>ec2-52-59-149-213.eu-central-1.compute.amazonaws.com
<span class="nv">runner_fedora1</span><span class="o">=</span>ec2-18-185-71-79.eu-central-1.compute.amazonaws.com
<span class="nv">runner_fedora2</span><span class="o">=</span>ec2-18-197-141-15.eu-central-1.compute.amazonaws.com
<span class="k">for</span> runner <span class="k">in</span> <span class="si">${</span><span class="nv">runner_leap1</span><span class="si">}</span> <span class="si">${</span><span class="nv">runner_fedora1</span><span class="si">}</span> <span class="si">${</span><span class="nv">runner_fedora2</span><span class="si">}</span><span class="p">;</span><span class="k">do</span>
    ssh -i ~/.ssh/id_cb_collect cb-collect@<span class="si">${</span><span class="nv">runner</span><span class="si">}</span> <span class="se">\</span>
        sudo sed -ie <span class="se">\&quot;</span>s@  host:.*@  host: <span class="si">${</span><span class="nv">BootstrapServersString</span><span class="si">}</span>@<span class="se">\&quot;</span> <span class="se">\</span>
        /etc/cloud_builder_broker.yml
    ssh -i ~/.ssh/id_cb_collect cb-collect@<span class="si">${</span><span class="nv">runner</span><span class="si">}</span> <span class="se">\</span>
        sudo systemctl restart cb-scheduler cb-info
<span class="k">done</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="commands/cb_ctl.html" class="btn btn-neutral float-left" title="cb-ctl" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Marcus Schäfer.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>