<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Runner Setup &mdash; Cloud Builder 0.2.18 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Request a Package Build" href="request_package_build.html" />
    <link rel="prev" title="Kafka Message Broker Setup" href="kafka_broker_setup.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> Cloud Builder
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="infrastructure_setup.html">Infrastructure Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="source_setup.html">Cloud Builder Source Setup</a><ul>
<li class="toctree-l2"><a class="reference internal" href="source_setup/git_package_source_setup.html">Git Package Source Setup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="source_setup/git_package_source_setup.html#understanding-the-project-structure">Understanding the project structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="source_setup/git_package_source_setup.html#understanding-cloud-builder-yml">Understanding <code class="file docutils literal notranslate"><span class="pre">cloud_builder.yml</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="source_setup/git_package_source_setup.html#understanding-cloud-builder-kiwi">Understanding <code class="file docutils literal notranslate"><span class="pre">cloud_builder.kiwi</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="source_setup/git_image_source_setup.html">Git Image Source Setup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="source_setup/git_image_source_setup.html#understanding-the-project-structure">Understanding the project structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="source_setup/git_image_source_setup.html#understanding-cloud-builder-yml">Understanding <code class="file docutils literal notranslate"><span class="pre">cloud_builder.yml</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="kafka_broker_setup.html">Kafka Message Broker Setup</a><ul>
<li class="toctree-l2"><a class="reference internal" href="kafka_broker_setup.html#create-and-install-the-control-plane">Create and Install the Control Plane</a></li>
<li class="toctree-l2"><a class="reference internal" href="kafka_broker_setup.html#control-plane-setup">Control Plane Setup</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Runner Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="request_package_build.html">Request a Package Build</a></li>
<li class="toctree-l1"><a class="reference internal" href="auto_rebuild_on_source_change.html">Auto Rebuild on Package Source Change</a></li>
<li class="toctree-l1"><a class="reference internal" href="auto_rebuild_on_build_dependencies.html">Auto Rebuild on Package Build Dependency Changes</a></li>
<li class="toctree-l1"><a class="reference internal" href="collect_and_build_project_repos.html">Collect and Build Project Repos</a><ul>
<li class="toctree-l2"><a class="reference internal" href="collect_and_build_project_repos.html#create-and-setup-the-reposerver-instance">Create and Setup the reposerver instance</a></li>
<li class="toctree-l2"><a class="reference internal" href="collect_and_build_project_repos.html#setup-apache-to-serve-the-repos">Setup Apache to Serve the Repos</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="commands.html">Overview Cloud Builder Services</a><ul>
<li class="toctree-l2"><a class="reference internal" href="commands/cb_fetch.html">cb-fetch</a><ul>
<li class="toctree-l3"><a class="reference internal" href="commands/cb_fetch.html#synopsis">SYNOPSIS</a></li>
<li class="toctree-l3"><a class="reference internal" href="commands/cb_fetch.html#description">DESCRIPTION</a></li>
<li class="toctree-l3"><a class="reference internal" href="commands/cb_fetch.html#options">OPTIONS</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="commands/cb_scheduler.html">cb-scheduler</a><ul>
<li class="toctree-l3"><a class="reference internal" href="commands/cb_scheduler.html#synopsis">SYNOPSIS</a></li>
<li class="toctree-l3"><a class="reference internal" href="commands/cb_scheduler.html#description">DESCRIPTION</a><ul>
<li class="toctree-l4"><a class="reference internal" href="commands/cb_scheduler.html#building-a-package">Building a package:</a></li>
<li class="toctree-l4"><a class="reference internal" href="commands/cb_scheduler.html#build-an-os-image">Build an OS image:</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="commands/cb_scheduler.html#options">OPTIONS</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="commands/cb_prepare.html">cb-prepare</a><ul>
<li class="toctree-l3"><a class="reference internal" href="commands/cb_prepare.html#synopsis">SYNOPSIS</a></li>
<li class="toctree-l3"><a class="reference internal" href="commands/cb_prepare.html#description">DESCRIPTION</a></li>
<li class="toctree-l3"><a class="reference internal" href="commands/cb_prepare.html#options">OPTIONS</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="commands/cb_run.html">cb-run</a><ul>
<li class="toctree-l3"><a class="reference internal" href="commands/cb_run.html#synopsis">SYNOPSIS</a></li>
<li class="toctree-l3"><a class="reference internal" href="commands/cb_run.html#description">DESCRIPTION</a></li>
<li class="toctree-l3"><a class="reference internal" href="commands/cb_run.html#options">OPTIONS</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="commands/cb_image.html">cb-image</a><ul>
<li class="toctree-l3"><a class="reference internal" href="commands/cb_image.html#synopsis">SYNOPSIS</a></li>
<li class="toctree-l3"><a class="reference internal" href="commands/cb_image.html#description">DESCRIPTION</a></li>
<li class="toctree-l3"><a class="reference internal" href="commands/cb_image.html#options">OPTIONS</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="commands/cb_info.html">cb-info</a><ul>
<li class="toctree-l3"><a class="reference internal" href="commands/cb_info.html#synopsis">SYNOPSIS</a></li>
<li class="toctree-l3"><a class="reference internal" href="commands/cb_info.html#description">DESCRIPTION</a></li>
<li class="toctree-l3"><a class="reference internal" href="commands/cb_info.html#options">OPTIONS</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="commands/cb_depsolver.html">cb-depsolver</a></li>
<li class="toctree-l2"><a class="reference internal" href="commands/cb_collect.html">cb-collect</a><ul>
<li class="toctree-l3"><a class="reference internal" href="commands/cb_collect.html#synopsis">SYNOPSIS</a></li>
<li class="toctree-l3"><a class="reference internal" href="commands/cb_collect.html#description">DESCRIPTION</a></li>
<li class="toctree-l3"><a class="reference internal" href="commands/cb_collect.html#options">OPTIONS</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="commands/cb_ctl.html">cb-ctl</a><ul>
<li class="toctree-l3"><a class="reference internal" href="commands/cb_ctl.html#synopsis">SYNOPSIS</a></li>
<li class="toctree-l3"><a class="reference internal" href="commands/cb_ctl.html#description">DESCRIPTION</a></li>
<li class="toctree-l3"><a class="reference internal" href="commands/cb_ctl.html#options">OPTIONS</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Cloud Builder</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Runner Setup</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/runner_setup.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="runner-setup">
<span id="id1"></span><h1>Runner Setup<a class="headerlink" href="#runner-setup" title="Permalink to this headline">¶</a></h1>
<p>A runner instance for Cloud Builder is a machine that actually builds
packages. The produced binaries stays on that machine and can
be fetched on demand for further processing. The runner must
be configured for a specific runner group. The runner group
name matches the name of the message broker queue/topic name such
that only package build requests for this runner group are
handled by the associated runner(s). There must be at least
one runner for each runner group. If there are more runners
the produced build requests will be evenly distributed across
the available runners. This is how Cloud Builder scales with the
amount of packages to build.</p>
<p>In the example setup of the control plane, the runner group
message topics <code class="xref py py-obj docutils literal notranslate"><span class="pre">suse</span></code> and <code class="xref py py-obj docutils literal notranslate"><span class="pre">fedora</span></code> were created. In addition
each of the runner groups was expected to serve 2 runners.
On the basis of this build power 4 runner instances must be
created and configured as follows:</p>
<ol class="arabic">
<li><p><strong>Start runner instances</strong></p>
<p>For the <code class="xref py py-obj docutils literal notranslate"><span class="pre">fedora</span></code> runner group the Fedora34 distribution
is used. For the <code class="xref py py-obj docutils literal notranslate"><span class="pre">suse</span></code> runner group the Leap15.3 distribution
is used.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nv">leap_15_3_ami</span><span class="o">=</span>ami-0b4f49bedf96b14c9
$ <span class="nv">fedora_34_ami</span><span class="o">=</span>ami-0b2a401a8b3f4edd3

$ <span class="k">for</span> runner <span class="k">in</span> <span class="si">${</span><span class="nv">leap_15_3_ami</span><span class="si">}</span> <span class="si">${</span><span class="nv">fedora_34_ami</span><span class="si">}</span><span class="p">;</span> <span class="k">do</span>
      aws ec2 run-instances <span class="se">\</span>
          --image-id <span class="si">${</span><span class="nv">runner</span><span class="si">}</span> <span class="se">\</span>
          --count <span class="m">2</span> <span class="se">\</span>
          --instance-type t2.micro <span class="se">\</span>
          --key-name MySSHKeyPairName <span class="se">\</span>
          --security-group-ids sg-MyGroup <span class="se">\</span>
          --subnet-id subnet-MySubNet<span class="p">;</span>
  <span class="k">done</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Runner instances requires storage RAM and CPU power.
In the cloud all of these components are cost factors.
With Cloud Builder it’s possible to differentiate runner groups
which can be designed such that there are some powerful
and some less powerful machines. For package and/or
image builds which are known to consume a lot of resources
a runner group can be used that meets these requirements.
That way the costs can be balanced. The selected free
(no costs) instance type <code class="xref py py-obj docutils literal notranslate"><span class="pre">t2.micro</span></code> used in the example
above, is not sufficient for a production system.</p>
</div>
</li>
<li><p><strong>Install Cloud Builder on the runners</strong></p>
<p>Login to each of the created Leap runner instances and install
Cloud Builder as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ ssh -i PathToPkeyMatchingMySSHKeyPairName <span class="se">\</span>
      ec2-user@InstanceIP

$ sudo zypper addrepo https://download.opensuse.org/repositories/Virtualization:/Appliances:/Staging/openSUSE_Leap_15.3 cloud-builder
$ sudo zypper install python3-cloud_builder
</pre></div>
</div>
<p>Login to each of the created Fedora runner instances and install
Cloud Builder as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ ssh -i PathToPkeyMatchingMySSHKeyPairName <span class="se">\</span>
      fedora@InstanceIP

$ sudo dnf config-manager <span class="se">\</span>
      --add-repo https://download.opensuse.org/repositories/Virtualization:/Appliances:/Staging/Fedora_34 <span class="se">\</span>
      --enable
$ sudo dnf install python3-cloud_builder
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As shown above access to the runners is performaed via <code class="xref py py-obj docutils literal notranslate"><span class="pre">ssh</span></code>
The username to access Fedora machines in the cloud is set
to <code class="xref py py-obj docutils literal notranslate"><span class="pre">fedora</span></code>. For Leap machines it is set set to <code class="xref py py-obj docutils literal notranslate"><span class="pre">ec2-user</span></code>.
This information is explained once and applies to all
following steps too.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>selinux</p>
<p>Fedora systems uses selinux. For building packages and images
the security policy could prevent required actions to complete
like the creation of a new rpm database in a new root directory.
To prevent this make sure selinux is not enforced by calling:
<code class="xref py py-obj docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">setenforce</span> <span class="pre">0</span></code></p>
</div>
</li>
<li><p><strong>Setup broker connection and runner group on the runners</strong></p>
<p>Login to each of the created runner instances and create
the file <code class="file docutils literal notranslate"><span class="pre">/etc/cloud_builder_broker.yml</span></code> as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo vi /etc/cloud_builder_broker.yml
</pre></div>
</div>
<p>Place the following content:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">broker</span><span class="p">:</span>
  <span class="nt">host</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">BootstrapServersString</span>
<span class="nt">this_host</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">external_IP_or_Hostname_of_this_instance</span>
</pre></div>
</div>
<p>See the ‘<strong>Configure</strong> <code class="xref py py-obj docutils literal notranslate"><span class="pre">cb-ctl</span></code>’ list item in the <a class="reference internal" href="kafka_broker_setup.html#control-plane-setup"><span class="std std-ref">Control Plane Setup</span></a>
for details how to obtain the broker credentials.</p>
<ul>
<li><p>Add the following content on the Leap runners only</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">runner</span><span class="p">:</span>
  <span class="nt">group</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">suse</span>
</pre></div>
</div>
</li>
<li><p>Place the following content on the Fedora runners only</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">runner</span><span class="p">:</span>
  <span class="nt">group</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">fedora</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p><strong>Setup git package source connection</strong></p>
<p>Login to each of the created runner instances and edit
the file <code class="file docutils literal notranslate"><span class="pre">/etc/cloud_builder</span></code> as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">CB_PROJECT</span><span class="o">=</span><span class="s2">&quot;https://github.com/OSInside/cloud-builder-packages.git&quot;</span>
<span class="nv">CB_BUILD_LIMIT</span><span class="o">=</span><span class="m">10</span>
</pre></div>
</div>
<p>The above settings are the default after install of Cloud Builder.
The used CB_PROJECT git repository is the Cloud Builder provided example git
repo containing some arbitrary package sources. It only serves the
purpose to let users test and run Cloud Builder. For production
change this value to your git project</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>CB_BUILD_LIMIT</p>
<p>Every runner comes with a build limit. This is the number
of simultaneously allowed build processes. If the limit is hit
the runner closes its connection to the message broker until the
number is below the maximum. For Apache kafka the close of the
connection of a consumer will cause a rebalance of all other still
connected consumers. This is an expensive operation and should be
avoided. The Cloud Builder set maximum of 10 package builds at the same time
is relatively conservative. It depends on the selected instance
type/memory and disk space to select an appropriate value. If in
doubt give it a try with the default setting, but keep in mind
about this value, especially for production use.</p>
</div>
</li>
<li><p><strong>Start</strong> <code class="xref py py-obj docutils literal notranslate"><span class="pre">cb-fetch-once</span></code> <strong>service</strong></p>
<p>Login to each of the created runner instances and fetch
the package source git once as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ sudo systemctl start cb-fetch-once
</pre></div>
</div>
<p>This will clone the configured CB_PROJECT git repo once on the
system. The <code class="xref py py-obj docutils literal notranslate"><span class="pre">cb-scheduler</span></code> service cares for the repo update via
<code class="xref py py-obj docutils literal notranslate"><span class="pre">git</span> <span class="pre">pull</span></code> on demand</p>
</li>
<li><p><strong>Start</strong> <code class="xref py py-obj docutils literal notranslate"><span class="pre">cb-scheduler</span></code> <strong>and</strong> <code class="xref py py-obj docutils literal notranslate"><span class="pre">cb-info</span></code> <strong>services</strong></p>
<p>Login to each of the created runner instances and start
the scheduler and info services as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ sudo systemctl start cb-scheduler
$ sudo systemctl start cb-info
</pre></div>
</div>
</li>
</ol>
<p>Congrats, the Cloud Builder package build backend is now running and can
build packages for Fedore/RHEL and SUSE/SLES based packages.
There are two runners available for each of these vendors.</p>
<p>Learn how to build the first package next: <a class="reference internal" href="request_package_build.html#request-package-build"><span class="std std-ref">Request a Package Build</span></a></p>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="kafka_broker_setup.html" class="btn btn-neutral float-left" title="Kafka Message Broker Setup" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="request_package_build.html" class="btn btn-neutral float-right" title="Request a Package Build" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Marcus Schäfer.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>